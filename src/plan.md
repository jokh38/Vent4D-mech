# Vent4D-Mech 개발 계획

이 문서는 `docs/Python 기반 폐 조직 역학 모델링 개발.txt`에 기술된 Vent4D-Mech 프로젝트의 개발 계획을 정의합니다.

## 개발 단계

1.  **영상 정합 (Image Registration) 모듈 개발 (`src/core/registration`)**
    *   **목표:** 4D-CT의 흡기(inhale) 및 호기(exhale) 영상 간의 변위 벡터 필드(DVF)를 계산합니다.
    *   **세부 과제:**
        *   SimpleITK를 이용한 고전적 B-스플라인 FFD 정합 기능 구현 (`simpleitk_registration.py`).
        *   VoxelMorph (PyTorch)를 이용한 딥러닝 기반 정합 기능 구현 (`voxelmorph_registration.py`).
        *   두 접근법을 통합하고 관리하는 인터페이스 (`deformable_registration.py`) 설계.
        *   이미지 전처리 및 유틸리티 함수 구현.

2.  **변형 분석 (Deformation Analysis) 모듈 개발 (`src/core/deformation`)**
    *   **목표:** DVF로부터 그린-라그랑주 변형률 텐서(Green-Lagrange strain tensor)를 계산합니다.
    *   **세부 과제:**
        *   `numpy.gradient`를 이용한 변위 구배 텐서 계산 기능 구현.
        *   그린-라그랑주 변형률 텐서 계산 로직 구현.
        *   관련 불변량(예: 체적 변형률) 계산 기능 추가.

3.  **구성 모델링 (Constitutive Modeling) 모듈 개발 (`src/core/mechanical`)**
    *   **목표:** 폐 조직의 비선형 기계적 거동을 정의하는 초탄성 모델을 구현합니다.
    *   **세부 과제:**
        *   네오-훅(Neo-Hookean), 무니-리블린(Mooney-Rivlin), 여(Yeoh) 모델 등 주요 초탄성 모델의 변형률 에너지 함수 정의.
        *   문헌에 기반한 재료 파라미터 기본값 설정 기능 구현.
        *   변형률로부터 응력을 계산하는 로직 구현.

4.  **역산 문제 해결 (Inverse Problem) 모듈 개발 (`src/core/inverse`)**
    *   **목표:** 관찰된 변형률과 FEM 모델로부터 환자 맞춤형 탄성 파라미터를 추정합니다.
    *   **세부 과제:**
        *   `scipy.optimize.least_squares`를 이용한 비선형 최소 제곱 최적화 프레임워크 구축.
        *   FEM 순방향 모델을 호출하는 잔차 함수 정의.
        *   티호노프(Tikhonov) 정규화와 같은 정규화 기법 적용.

5.  **MicrostructureDB 구축 (`src/core/microstructure`)**
    *   **목표:** 거시적 CT 영상 특징(HU 값)과 미시적 기계적 특성을 연결하는 대리 모델을 구축합니다.
    *   **세부 과제:**
        *   Human Organ Atlas(HOA) 데이터 처리 및 RVE(대표 체적 요소) 추출 로직 구현 (개념 증명 수준).
        *   추출된 RVE로부터 유효 재료 파라미터를 계산하는 워크플로우 설계 (시뮬레이션).
        *   HU 값과 재료 파라미터를 매핑하는 조회 테이블(LUT) 또는 머신러닝 모델 구현.

6.  **유한요소(FEM) 워크플로우 개발 (`src/core/fem`)**
    *   **목표:** Python 기반 FEM 라이브러리를 사용하여 폐의 변형을 시뮬레이션하는 순방향 모델을 구현합니다.
    *   **세부 과제:**
        *   EasyFEA 또는 SfePy를 이용한 3D 폐 메쉬 생성 및 관리 기능 구현.
        *   DVF를 경계 조건으로 적용하는 로직 구현.
        *   공간적으로 변화하는 재료 특성을 할당하고 비선형 FEM 해석을 수행하는 기능 구현.

7.  **전체 파이프라인 통합 및 최적화 (`src/pipeline.py`)**
    *   **목표:** 개발된 모든 모듈을 통합하여 엔드-투-엔드 파이프라인을 완성하고 성능을 최적화합니다.
    *   **세부 과제:**
        *   각 모듈을 순차적으로 호출하는 파이프라인 스크립트 작성.
        *   CuPy, Numba 등을 활용한 GPU 가속 적용.
        *   `multiprocessing`을 이용한 환자 데이터 병렬 처리 구현.

8.  **검증 및 문서화**
    *   **목표:** 모델의 정확성을 검증하고, 코드 사용법을 문서화합니다.
    *   **세부 과제:**
        *   SPECT/CT와 같은 실측 데이터와의 비교 검증 로직 구현.
        *   각 모듈 및 함수의 기능, 파라미터, 사용 예시를 설명하는 API 문서 작성.
        *   프로젝트 README 업데이트.

9.  **pre-commit 단계 완료**
    *   **목표:** 제출 전 코드 품질을 보장하기 위해 필요한 테스트, 검증, 검토 및 성찰을 수행합니다.
    *   **세부 과제:**
        *   단위 테스트 및 통합 테스트 실행.
        *   코드 정적 분석 및 포매팅 확인.
        *   `pre-commit` 훅을 통해 자동화된 검사 수행.

10. **제출**
    *   **목표:** 모든 개발 및 검증이 완료된 후, 변경 사항을 버전 관리 시스템에 제출합니다.
    *   **세부 과제:**
        *   적절한 커밋 메시지와 함께 코드 변경 사항 커밋.
        *   새로운 기능 브랜치를 생성하여 푸시.
        *   풀 리퀘스트(Pull Request) 생성.